KindEditor.plugin("table",function(a){function c(a,c){c=c.toUpperCase(),a.css("background-color",c),a.css("color","#000000"===c?"#FFFFFF":"#000000"),a.html(c)}function g(g,v){function b(){a.each(S,function(){this.remove()}),S=[],a(document).unbind("click,mousedown",b),g.unbind("click,mousedown",b)}v.bind("click,mousedown",function(e){e.stopPropagation()}),v.click(function(){b();var v=a(this),k=v.pos(),w=a.colorpicker({x:k.x,y:k.y+v.height(),z:811214,selectedColor:a(this).html(),colors:h.colorTable,noColor:h.lang("noColor"),shadowMode:h.shadowMode,click:function(a){c(v,a),b()}});S.push(w),a(document).bind("click,mousedown",b),g.bind("click,mousedown",b)})}function v(a,c,g){for(var v=0,i=0,h=c.cells.length;h>i&&c.cells[i]!=g;i++)v+=c.cells[i].rowSpan-1;return g.cellIndex-v}var h=this,b="table",k=h.lang(b+"."),w="ke-zeroborder",S=[];h.plugin.table={prop:function(v){var S=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+k.cells+"</label>",k.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',k.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+k.size+"</label>",k.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+k.percent+"</option>",'<option value="px">'+k.px+"</option>","</select> &nbsp; ",k.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+k.percent+"</option>",'<option value="px">'+k.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+k.space+"</label>",k.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',k.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+k.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+k.alignDefault+"</option>",'<option value="left">'+k.alignLeft+"</option>",'<option value="center">'+k.alignCenter+"</option>",'<option value="right">'+k.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+k.border+"</label>",k.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',k.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+k.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),y=h.cmd.range.createBookmark(),C=h.createDialog({name:b,width:500,title:h.lang(b),body:S,beforeRemove:function(){P.unbind()},yesBtn:{name:h.lang("yes"),click:function(){var c=T.val(),g=A.val(),v=I.val(),b=R.val(),k=$.val(),S=H.val(),C=W.val(),B=D.val(),L=E.val(),N=M.val(),z=a(P[0]).html()||"",j=a(P[1]).html()||"";if(0==c||!/^\d+$/.test(c))return alert(h.lang("invalidRows")),void T[0].focus();if(0==g||!/^\d+$/.test(g))return alert(h.lang("invalidRows")),void A[0].focus();if(!/^\d*$/.test(v))return alert(h.lang("invalidWidth")),void I[0].focus();if(!/^\d*$/.test(b))return alert(h.lang("invalidHeight")),void R[0].focus();if(!/^\d*$/.test(C))return alert(h.lang("invalidPadding")),void W[0].focus();if(!/^\d*$/.test(B))return alert(h.lang("invalidSpacing")),void D[0].focus();if(!/^\d*$/.test(N))return alert(h.lang("invalidBorder")),void M[0].focus();if(F)return""!==v?F.width(v+k):F.css("width",""),void 0!==F[0].width&&F.removeAttr("width"),""!==b?F.height(b+S):F.css("height",""),void 0!==F[0].height&&F.removeAttr("height"),F.css("background-color",j),void 0!==F[0].bgColor&&F.removeAttr("bgColor"),""!==C?F[0].cellPadding=C:F.removeAttr("cellPadding"),""!==B?F[0].cellSpacing=B:F.removeAttr("cellSpacing"),""!==L?F[0].align=L:F.removeAttr("align"),""!==N?F.attr("border",N):F.removeAttr("border"),""===N||"0"===N?F.addClass(w):F.removeClass(w),""!==z?F.attr("borderColor",z):F.removeAttr("borderColor"),h.hideDialog().focus(),h.cmd.range.moveToBookmark(y),h.cmd.select(),void h.addBookmark();var K="";""!==v&&(K+="width:"+v+k+";"),""!==b&&(K+="height:"+b+S+";"),""!==j&&(K+="background-color:"+j+";");var U="<table";""!==K&&(U+=' style="'+K+'"'),""!==C&&(U+=' cellpadding="'+C+'"'),""!==B&&(U+=' cellspacing="'+B+'"'),""!==L&&(U+=' align="'+L+'"'),""!==N&&(U+=' border="'+N+'"'),(""===N||"0"===N)&&(U+=' class="'+w+'"'),""!==z&&(U+=' bordercolor="'+z+'"'),U+=">";for(var i=0;c>i;i++){U+="<tr>";for(var G=0;g>G;G++)U+="<td>"+(a.IE?"&nbsp;":"<br />")+"</td>";U+="</tr>"}U+="</table>",a.IE||(U+="<br />"),h.insertHtml(U),h.select().hideDialog().focus(),h.addBookmark()}}}),B=C.div,T=a('[name="rows"]',B).val(3),A=a('[name="cols"]',B).val(2),I=a('[name="width"]',B).val(100),R=a('[name="height"]',B),$=a('[name="widthType"]',B),H=a('[name="heightType"]',B),W=a('[name="padding"]',B).val(2),D=a('[name="spacing"]',B).val(0),E=a('[name="align"]',B),M=a('[name="border"]',B).val(1),P=a(".ke-input-color",B);g(B,P.eq(0)),g(B,P.eq(1)),c(P.eq(0),"#000000"),c(P.eq(1),""),T[0].focus(),T[0].select();var F;if(!v&&(F=h.plugin.getSelectedTable())){T.val(F[0].rows.length),A.val(F[0].rows.length>0?F[0].rows[0].cells.length:0),T.attr("disabled",!0),A.attr("disabled",!0);var L,N=F[0].style.width||F[0].width,z=F[0].style.height||F[0].height;void 0!==N&&(L=/^(\d+)((?:px|%)*)$/.exec(N))?(I.val(L[1]),$.val(L[2])):I.val(""),void 0!==z&&(L=/^(\d+)((?:px|%)*)$/.exec(z))&&(R.val(L[1]),H.val(L[2])),W.val(F[0].cellPadding||""),D.val(F[0].cellSpacing||""),E.val(F[0].align||""),M.val(void 0===F[0].border?"":F[0].border),c(P.eq(0),a.toHex(F.attr("borderColor")||"")),c(P.eq(1),a.toHex(F[0].style.backgroundColor||F[0].bgColor||"")),I[0].focus(),I[0].select()}},cellprop:function(){var v=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+k.size+"</label>",k.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+k.percent+"</option>",'<option value="px">'+k.px+"</option>","</select> &nbsp; ",k.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+k.percent+"</option>",'<option value="px">'+k.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+k.align+"</label>",k.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+k.alignDefault+"</option>",'<option value="left">'+k.alignLeft+"</option>",'<option value="center">'+k.alignCenter+"</option>",'<option value="right">'+k.alignRight+"</option>","</select> ",k.verticalAlign+' <select name="verticalAlign">','<option value="">'+k.alignDefault+"</option>",'<option value="top">'+k.alignTop+"</option>",'<option value="middle">'+k.alignMiddle+"</option>",'<option value="bottom">'+k.alignBottom+"</option>",'<option value="baseline">'+k.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+k.border+"</label>",k.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',k.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+k.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),w=h.cmd.range.createBookmark(),S=h.createDialog({name:b,width:500,title:h.lang("tablecell"),body:v,beforeRemove:function(){D.unbind()},yesBtn:{name:h.lang("yes"),click:function(){var c=C.val(),g=B.val(),v=T.val(),b=A.val(),k=(I.val(),R.val(),$.val()),S=H.val(),y=W.val(),E=a(D[0]).html()||"",P=a(D[1]).html()||"";return/^\d*$/.test(c)?/^\d*$/.test(g)?/^\d*$/.test(y)?(M.css({width:""!==c?c+v:"",height:""!==g?g+b:"","background-color":P,"text-align":k,"vertical-align":S,"border-width":y,"border-style":""!==y?"solid":"","border-color":E}),h.hideDialog().focus(),h.cmd.range.moveToBookmark(w),h.cmd.select(),void h.addBookmark()):(alert(h.lang("invalidBorder")),void W[0].focus()):(alert(h.lang("invalidHeight")),void B[0].focus()):(alert(h.lang("invalidWidth")),void C[0].focus())}}}),y=S.div,C=a('[name="width"]',y).val(100),B=a('[name="height"]',y),T=a('[name="widthType"]',y),A=a('[name="heightType"]',y),I=a('[name="padding"]',y).val(2),R=a('[name="spacing"]',y).val(0),$=a('[name="textAlign"]',y),H=a('[name="verticalAlign"]',y),W=a('[name="border"]',y).val(1),D=a(".ke-input-color",y);g(y,D.eq(0)),g(y,D.eq(1)),c(D.eq(0),"#000000"),c(D.eq(1),""),C[0].focus(),C[0].select();var E,M=h.plugin.getSelectedCell(),P=M[0].style.width||M[0].width||"",F=M[0].style.height||M[0].height||"";(E=/^(\d+)((?:px|%)*)$/.exec(P))?(C.val(E[1]),T.val(E[2])):C.val(""),(E=/^(\d+)((?:px|%)*)$/.exec(F))&&(B.val(E[1]),A.val(E[2])),$.val(M[0].style.textAlign||""),H.val(M[0].style.verticalAlign||"");var L=M[0].style.borderWidth||"";L&&(L=parseInt(L)),W.val(L),c(D.eq(0),a.toHex(M[0].style.borderColor||"")),c(D.eq(1),a.toHex(M[0].style.backgroundColor||"")),C[0].focus(),C[0].select()},insert:function(){this.prop(!0)},"delete":function(){var a=h.plugin.getSelectedTable();h.cmd.range.setStartBefore(a[0]).collapse(!0),h.cmd.select(),a.remove(),h.addBookmark()},colinsert:function(c){var g=h.plugin.getSelectedTable()[0],b=h.plugin.getSelectedRow()[0],k=h.plugin.getSelectedCell()[0],w=k.cellIndex+c;w+=g.rows[0].cells.length-b.cells.length;for(var i=0,S=g.rows.length;S>i;i++){var y=g.rows[i],C=y.insertCell(w);C.innerHTML=a.IE?"":"<br />",w=v(g,y,C)}h.cmd.range.selectNodeContents(k).collapse(!0),h.cmd.select(),h.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(c){var g=h.plugin.getSelectedTable()[0],v=h.plugin.getSelectedRow()[0],b=h.plugin.getSelectedCell()[0],k=v.rowIndex;1===c&&(k=v.rowIndex+(b.rowSpan-1)+c);for(var w=g.insertRow(k),i=0,S=v.cells.length;S>i;i++){v.cells[i].rowSpan>1&&(S-=v.cells[i].rowSpan-1);var y=w.insertCell(i);1===c&&v.cells[i].colSpan>1&&(y.colSpan=v.cells[i].colSpan),y.innerHTML=a.IE?"":"<br />"}for(var C=k;C>=0;C--){var B=g.rows[C].cells;if(B.length>i){for(var T=b.cellIndex;T>=0;T--)B[T].rowSpan>1&&(B[T].rowSpan+=1);break}}h.cmd.range.selectNodeContents(b).collapse(!0),h.cmd.select(),h.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var a=h.plugin.getSelectedTable()[0],c=h.plugin.getSelectedRow()[0],g=h.plugin.getSelectedCell()[0],v=c.rowIndex,b=v+g.rowSpan,k=a.rows[b];if(!(a.rows.length<=b)){var w=g.cellIndex;if(!(k.cells.length<=w)){var S=k.cells[w];g.colSpan===S.colSpan&&(g.rowSpan+=S.rowSpan,k.deleteCell(w),h.cmd.range.selectNodeContents(g).collapse(!0),h.cmd.select(),h.addBookmark())}}},colmerge:function(){var a=(h.plugin.getSelectedTable()[0],h.plugin.getSelectedRow()[0]),c=h.plugin.getSelectedCell()[0],g=(a.rowIndex,c.cellIndex),v=g+1;if(!(a.cells.length<=v)){var b=a.cells[v];c.rowSpan===b.rowSpan&&(c.colSpan+=b.colSpan,a.deleteCell(v),h.cmd.range.selectNodeContents(c).collapse(!0),h.cmd.select(),h.addBookmark())}},rowsplit:function(){var c=h.plugin.getSelectedTable()[0],g=h.plugin.getSelectedRow()[0],b=h.plugin.getSelectedCell()[0],k=g.rowIndex;if(1!==b.rowSpan){for(var w=v(c,g,b),i=1,S=b.rowSpan;S>i;i++){var y=c.rows[k+i],C=y.insertCell(w);b.colSpan>1&&(C.colSpan=b.colSpan),C.innerHTML=a.IE?"":"<br />",w=v(c,y,C)}a(b).removeAttr("rowSpan"),h.cmd.range.selectNodeContents(b).collapse(!0),h.cmd.select(),h.addBookmark()}},colsplit:function(){var c=(h.plugin.getSelectedTable()[0],h.plugin.getSelectedRow()[0]),g=h.plugin.getSelectedCell()[0],v=g.cellIndex;if(1!==g.colSpan){for(var i=1,b=g.colSpan;b>i;i++){var k=c.insertCell(v+i);g.rowSpan>1&&(k.rowSpan=g.rowSpan),k.innerHTML=a.IE?"":"<br />"}a(g).removeAttr("colSpan"),h.cmd.range.selectNodeContents(g).collapse(!0),h.cmd.select(),h.addBookmark()}},coldelete:function(){for(var c=h.plugin.getSelectedTable()[0],g=h.plugin.getSelectedRow()[0],v=h.plugin.getSelectedCell()[0],b=v.cellIndex,i=0,k=c.rows.length;k>i;i++){var w=c.rows[i],S=w.cells[b];S.colSpan>1?(S.colSpan-=1,1===S.colSpan&&a(S).removeAttr("colSpan")):w.deleteCell(b),S.rowSpan>1&&(i+=S.rowSpan-1)}0===g.cells.length?(h.cmd.range.setStartBefore(c).collapse(!0),h.cmd.select(),a(c).remove()):h.cmd.selection(!0),h.addBookmark()},rowdelete:function(){for(var c=h.plugin.getSelectedTable()[0],g=h.plugin.getSelectedRow()[0],v=h.plugin.getSelectedCell()[0],b=g.rowIndex,i=v.rowSpan-1;i>=0;i--)c.deleteRow(b+i);0===c.rows.length?(h.cmd.range.setStartBefore(c).collapse(!0),h.cmd.select(),a(c).remove()):h.cmd.selection(!0),h.addBookmark()}},h.clickToolbar(b,h.plugin.table.prop)});